name: Build ImmortalWrt Optimized

on:
  workflow_dispatch:
    inputs:
      ssh_debug:
        description: 'Enable SSH debug session'
        required: false
        default: 'false'

env:
  TERM: xterm
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    name: Build ImmortalWrt
    steps:
      - name: Start SSH debug session (optional)
        if: ${{ github.event.inputs.ssh_debug == 'true' }}
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true

      - name: ðŸ”§ Clone ImmortalWrt Source
        run: |
          git clone https://github.com/immortalwrt/immortalwrt.git .
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: â±ï¸ Cache dl and toolchain
        uses: actions/cache@v3
        with:
          path: |
            dl
            build_dir/host
            staging_dir/host
          key: ${{ runner.os }}-openwrt-${{ hashFiles('**/feeds.conf.default') }}
          restore-keys: |
            ${{ runner.os }}-openwrt

      - name: Run diy.sh
        working-directory: ImmortalWrt
        run: |
          chmod +x diy.sh
          ./diy.sh

      - name: ðŸ“ Load .config
        run: |
          [ -f .config ] && echo "å·²åŠ è½½è‡ªå®šä¹‰ .config"

      - name: âš™ï¸ Compile firmware
        run: |
          make defconfig
          make download -j$(nproc)
          make -j$(nproc) V=s

      - name: Rename Firmware with Timestamp
        run: |
          mkdir -p output
          DATE=$(date +%Y%m%d-%H%M)
          find bin/targets/ -name "*.*" -exec cp {} output/ \;
          cd output
          for f in *; do mv "$f" "immortalwrt-x86_64-$DATE-$f"; done

      - name: ðŸ“¤ Upload firmware to GitHub Artifact
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-x86_64
          path: output

      - name: Archive modified config files
        run: |
          mkdir -p config_backup
          cp .config feeds.conf.default config_backup/
          zip -r config_files.zip config_backup

      - name: Upload config as artifact
        uses: actions/upload-artifact@v4
        with:
          name: modified-config
          path: config_files.zip

      - name: Generate selected plugin list
        run: |
          grep '^CONFIG_PACKAGE_' .config | grep '=y' | cut -d_ -f3- | cut -d= -f1 | sort > selected_plugins.txt

      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: x86_64-${{ github.run_number }}
          name: ImmortalWrt ${{ github.run_id }}
          body_path: selected_plugins.txt
          files: output/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
